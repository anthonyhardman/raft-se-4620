name: Raftr
run-name: ${{ github.actor }} is deploying ðŸš€
on: [push]

jobs:
  Build-1:
    runs-on: [self-hosted, raft-1]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build docker images
        run: |
          cd ops
          docker compose build -f docker-compose-1.yml

  Build-2:
    runs-on: [self-hosted, raft-2]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build docker images
        run: |
          cd ops
          docker compose build -f docker-compose-2.yml

  Test:
    runs-on: [self-hosted, raft-1]
    needs: [Build-1, Build-2]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Test
        run: |
          dotnet test Raft.Tests 

  Deploy-1:
    runs-on: [self-hosted, raft-1]
    needs: Test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deploy to production
        run: |
          cd ops
          docker compose up -d -f docker-compose-1.yml

  Deploy-2:
    runs-on: [self-hosted, raft-2]
    needs: Test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Deploy to production
        run: |
          cd ops
          docker compose up -d -f docker-compose-2.yml